<!-- Request Configuration -->
<div class="grow">
    <form
        class="flex flex-col justify-between h-full"
        [formGroup]="request.form"
        (ngSubmit)="onSubmit(request)"
    >
        <div>
            <div class="my-6">
                <h5 class="mb-2 font-bold opacity-100 leading-lg">Input reactant pair for C-N coupling</h5>
                <h6 class="leading-lg text-text-secondary">
                    Please input one aryl halide / amine reactant pair to
                    analyze for reaction condition predictions (catalyst, base,
                    solvent).
                </h6>
            </div>

            <div class="flex flex-col gap-6">
                <p-panel>
                    <ng-template pTemplate="header">
                        <span class="grow">Reactant Pair</span>
                        <div class="flex gap-2">
                            <button
                                type="button"
                                id="btn-use-example"
                                class="flex items-center btn-outline"
                                (click)="useExample()"
                            >
                                <i class="mr-2 pi pi-box"></i>
                                Use an Example
                            </button>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="content">
                        <p-table 
                            formArrayName="reactantPairs"
                            [value]="request.form.controls['reactantPairs'].controls"
                        >
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>No.</th>
                                    <th>Name</th>
                                    <th>Aryl Halide</th>
                                    <th>Amine</th>
                                    <th></th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-rp let-i="rowIndex">
                                <tr *ngIf="rp.controls['status'].value === 'view'">
                                    <td>{{ i + 1 }}</td>
                                    <td>{{ rp.controls['reactantPairName'].value }}</td>
                                    <td>{{ rp.controls['arylHalideName'].value }}</td>
                                    <td>{{ rp.controls['amineName'].value }}</td>
                                    <td>
                                        <div class="flex justify-end gap-2 text-[#6C757D] pr-8">
                                            <button type="button" title="Copy Reactant Pair" (click)="request.duplicateReactantPair(i)">
                                                <i class="pi pi-copy"></i>
                                            </button>
                                            <button type="button" title="Edit Reactant Pair" (click)="rp.controls['status'].setValue('edit')">
                                                <i class="pi pi-pencil"></i>
                                            </button>
                                            <button type="button" title="Remove Reactant Pair" (click)="request.removeReactantPair(i)">
                                                <i class="pi pi-times"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr *ngIf="rp.controls['status'].value === 'view' 
                                    && i === request.form.controls['reactantPairs'].controls.length - 1">
                                    <td colspan="5">
                                        <button
                                            type="button"
                                            id="btn-add-reactant-pair"
                                            class="flex items-center btn-outline !bg-[--surface-b]"
                                            (click)="request.addReactantPair()"
                                        >
                                            <i class="mr-2 pi pi-plus"></i>
                                            Add Reactant Pair
                                        </button>
                                    </td>
                                </tr>
                                <tr *ngIf="rp.controls['status'].value === 'edit'" [formGroupName]="i">
                                    <td colspan="5">
                                        <div class="flex flex-col border border-dotted rounded-md bg-gray-50 p-4 w-full">
                                            <div class="flex justify-between mb-3">
                                                <h5 class="mt-0 opacity-100 font-semibold">Add Reactant Pair</h5>
                                                <button
                                                    title="Remove Reactant Pair"
                                                    type="button"
                                                    (click)="request.removeReactantPair(i)"
                                                >
                                                    <i class="pi pi-times"></i>
                                                </button>
                                            </div>
                                            <div id="container-somn-input">
                                                <section id="input-name-reactant-pair"  class="max-w-[80%]">
                                                    <p class="font-semibold leading-lg">Name your reactant pair</p>
                                                    <input
                                                        pInputText
                                                        class="w-full mt-2"
                                                        placeholder="Enter reactant pair name..."
                                                        formControlName="reactantPairName"
                                                    />
                                                    <div *ngIf="
                                                            rp.controls['reactantPairName'].dirty 
                                                            && rp.controls['reactantPairName'].errors
                                                            && rp.controls['reactantPairName'].errors['required'] 
                                                        "
                                                        class="text-xs text-red-500 my-1"
                                                    >
                                                        This field is required
                                                    </div>
                                                </section>
                                                <section id="input-reactants" class="mt-2">
                                                    <p class="font-semibold leading-lg">
                                                        Enter your reactants<i
                                                            class="ml-2 pi pi-info-circle"
                                                            pTooltip="Somn has been trained on reactants with only one reaction site; thus, it is encouraged to input reactants with one reaction site for analysis. If you enter a reactant with multiple reaction sites, you will be required to specify the intended reaction site."
                                                        ></i>
                                                    </p>
                                                    <div class="flex w-full gap-2">
                                                        <div class="flex flex-col w-2/5">
                                                            <div
                                                                class="flex justify-between mt-2 text-sm"
                                                            >
                                                                <small class="font-semibold leading-xl"
                                                                    >Aryl Halide
                                                                    (bromide/chloride)</small
                                                                >
                                                                <small class="leading-xl text-text-secondary"
                                                                    >Example:
                                                                    <small
                                                                        class="font-semibold underline cursor-pointer"
                                                                        (click)="
                                                                            rp.controls['arylHalideName'].setValue('Bromobenzene');
                                                                            rp.controls['arylHalide'].setValue({
                                                                                input: 'C1=CC=C(C=C1)Br',
                                                                                input_type: CheckReactionSiteRequest.InputTypeEnum.Smi,
                                                                                reactionSite: '-'
                                                                            });
                                                                        "
                                                                        >Bromobenzene</small
                                                                    >
                                                                </small>
                                                            </div>
                                                            <input
                                                                pInputText
                                                                class="w-full mt-2"
                                                                placeholder="Enter aryl halide name..."
                                                                formControlName="arylHalideName"
                                                            />
                                                            <div *ngIf="
                                                                    rp.controls['arylHalideName'].dirty 
                                                                    && rp.controls['arylHalideName'].errors
                                                                    && rp.controls['arylHalideName'].errors['required'] 
                                                                "
                                                                class="text-xs text-red-500 my-1"
                                                            >
                                                                This field is required
                                                            </div>
                                                            <app-marvinjs-input
                                                                class="mt-2"
                                                                placeholder="Enter aryl halide SMILES..."
                                                                formControlName="arylHalide"
                                                                type="el"
                                                                (heavyAtomsWarning)="arylHalideHasHeavyAtoms = $event"
                                                            >
                                                            </app-marvinjs-input>
                                                        </div>
                                                        <div class="flex flex-col w-2/5">
                                                            <div
                                                                class="flex justify-between mt-2 text-sm"
                                                            >
                                                                <small class="font-semibold leading-xl"
                                                                    >Amine</small
                                                                >
                                                                <small class="leading-xl text-text-secondary"
                                                                    >Example:
                                                                    <small
                                                                        class="font-semibold underline cursor-pointer"
                                                                        (click)="
                                                                            rp.controls['amineName'].setValue('Aniline');
                                                                            rp.controls['amine'].setValue({
                                                                                input: 'C1=CC=C(C=C1)N',
                                                                                input_type: CheckReactionSiteRequest.InputTypeEnum.Smi,
                                                                                reactionSite: '-'
                                                                            });
                                                                        "
                                                                        >Aniline</small
                                                                    >
                                                                </small>
                                                            </div>
                                                            <input
                                                                pInputText
                                                                class="w-full mt-2"
                                                                placeholder="Enter amine name..."
                                                                formControlName="amineName"
                                                            />
                                                            <div *ngIf="
                                                                    rp.controls['amineName'].dirty 
                                                                    && rp.controls['amineName'].errors
                                                                    && rp.controls['amineName'].errors['required'] 
                                                                "
                                                                class="text-xs text-red-500 my-1"
                                                            >
                                                                This field is required
                                                            </div>
                                                            <app-marvinjs-input
                                                                class="mt-2"
                                                                placeholder="Enter amine SMILES..."
                                                                type="nuc"
                                                                formControlName="amine"
                                                                (heavyAtomsWarning)="amineHasHeavyAtoms = $event"
                                                            >
                                                            </app-marvinjs-input>
                                                        </div>
                                                        <div class="flex flex-col w-1/5 items-center justify-center relative">
                                                            <p-button
                                                                label="Add Reactant Pair"
                                                                class="absolute top-8"
                                                                [disabled]="rp.invalid"
                                                                (onClick)="rp.controls['status'].setValue('view')"
                                                                styleClass="bg-[#224063] font-normal"
                                                            ></p-button>
                                                        </div>
                                                    </div>
                                                </section>
                                            </div>
                                        </div>
                                    </td>
                                </tr> 
                            </ng-template>
                        </p-table>
                    </ng-template>
                </p-panel>
            </div>
        </div>

        <!-- Subscription Email Input -->
        <div
            id="input-subscription-email"
            class="sticky bottom-0 flex justify-between rounded-t-md bg-[#F3F5FB] px-10 pt-8"
        >
            <div class="flex flex-col">
                <div class="flex items-end justify-center mb-2">
                    <span class="pr-12 mb-1">
                        <h5 class="inline m-0 mr-2 font-semibold opacity-100 leading-lg">Email</h5>
                        <h6 class="inline-block leading-lg">Leave an email to get an notification when your
                        results are ready.</h6>
                    </span>
                </div>
                <div class="w-full">
                    <input
                        id="subscriber-email"
                        type="email"
                        aria-describedby="subscriber-email-help"
                        [class]="'h-12 w-full'
                        + ((request.form.controls['subscriberEmail'].invalid
                            && request.form.controls['subscriberEmail'].dirty) ? ' ng-invalid ng-dirty' : '')"
                        pInputText
                        placeholder="Enter email here"
                        formControlName="subscriberEmail"
                    />
                    <small
                        *ngIf="request.form.controls['subscriberEmail'].invalid
                            && request.form.controls['subscriberEmail'].dirty"
                        id="subscriber-email-help"
                        class="block mt-2 p-error"
                        >Email is invalid.</small
                    >
                </div>
                <div class="py-4">
                    <p-checkbox
                        name="subscription"
                        styleClass="subscription-checkbox"
                        label="Agree to receive email notifications and updates about Somn."
                        [binary]="true"
                        [formControl]="request.form.controls['agreeToSubscription']"
                    ></p-checkbox>
                </div>
            </div>
            <div id="btn-use-somn">
                <p-button
                    label="Analyze Using Somn"
                    type="submit"
                    styleClass="bg-[#224063]"
                    [disabled]="request.form.invalid"
                    iconPos="right"
                    icon="pi pi-arrow-right"
                ></p-button>
            </div>
        </div>
    </form>
</div>

<p-dialog
    #tutorialDialog
    header="Configuration"
    [(visible)]="displayTutorial" 
    [modal]="true" 
    [style]="{ width: '350px' }" 
    [draggable]="false" 
    [resizable]="false"
>
    <div class="flex flex-col gap-6 -mb-2">
        <p class="leading-xl">
            It's time to set up your job! Would you like us to show you around the request configuration page? You can always access this tour later.
        </p>
        <div class="flex items-center gap-2">
            <p-checkbox [(ngModel)]="tutorialService.showTutorial" [binary]="true"></p-checkbox>
            <label for="show-tour">Don't show this message again</label>
        </div>
        <div class="flex justify-between">
            <p-button 
                (onClick)="displayTutorial = false"
                styleClass="p-button-outlined" 
                label="Skip Tour">
            </p-button>
            <p-button
                (onClick)="displayTutorial = false; tutorialService.driver.drive()"
                label="Start Tour"
                styleClass="bg-[#224063]"
            ></p-button>
        </div>
    </div>
</p-dialog>

<p-dialog
    #heavyAtomsDialog
    header="Whoah, that's a lot of atoms!"
    [(visible)]="displayHeavyAtomsDialog" 
    [modal]="true" 
    [style]="{ width: '350px' }" 
    [draggable]="false" 
    [resizable]="false"
>
    <div class="flex flex-col gap-6 -mb-2">
        <p class="leading-xl">
            It looks like you've entered {{ 
                arylHalideHasHeavyAtoms && amineHasHeavyAtoms 
                ? 'both an aryl halide and an amine' 
                : (arylHalideHasHeavyAtoms ? 'an aryl halide' : 'an amine') 
            }} with over 150 heavy atoms, which may not be an appropriate input for Somn. 
            <br/>
            <br/>
            You may still use these reactants, but the job may time out or you might get some funky results. 
            If this happens, truncating the molecule may allow you to pursue this reactive motif.
        </p>
        <div class="flex justify-between">
            <p-button 
                (onClick)="displayHeavyAtomsDialog = false"
                styleClass="p-button-outlined" 
                label="Edit Input">
            </p-button>
            <p-button
                (onClick)="displayHeavyAtomsDialog = false; submitJob()"
                label="Run Job Anyway"
                styleClass="bg-[#224063]"
            ></p-button>
        </div>
    </div>
</p-dialog>